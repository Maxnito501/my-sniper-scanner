import streamlit as st
import yfinance as yf

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤
st.set_page_config(page_title="Buffett Scan", page_icon="üíé", layout="centered")

# ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
st.title("üíé Buffett Value Scanner")
st.caption("‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏∏‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö '‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏ô ‡∏ö‡∏±‡∏ü‡πÄ‡∏ü‡∏ï‡∏ï‡πå' (‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏î‡∏µ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å)")

# ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô
symbol = st.text_input("‡∏õ‡πâ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (‡πÄ‡∏ä‡πà‡∏ô PTT, SCB, CPALL)", "").upper()

if st.button("üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏∏‡πâ‡∏ô"):
    if not symbol:
        st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")
    else:
        with st.spinner(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô {symbol}..."):
            try:
                # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Yahoo Finance
                ticker = f"{symbol}.BK" if not symbol.endswith(".BK") else symbol
                stock = yf.Ticker(ticker)
                info = stock.info
                
                # ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0)
                pe = info.get('trailingPE', 0)
                pbv = info.get('priceToBook', 0)
                div_yield = (info.get('dividendYield', 0) or 0) * 100
                roe = (info.get('returnOnEquity', 0) or 0) * 100
                price = info.get('currentPrice', 0)
                
                # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                st.metric(f"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î {symbol}", f"{price:.2f} ‡∏ö‡∏≤‡∏ó")
                
                st.divider()
                
                # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå 3 ‡∏°‡∏¥‡∏ï‡∏¥ ---
                c1, c2, c3 = st.columns(3)
                
                # 1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡πÅ‡∏û‡∏á (P/E)
                with c1:
                    st.subheader("1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡πÅ‡∏û‡∏á")
                    if 0 < pe < 15:
                        st.success(f"‚úÖ P/E: {pe:.2f}\n(‡∏ñ‡∏π‡∏Å)")
                        s1 = 1
                    elif 15 <= pe < 25:
                        st.warning(f"‚ö†Ô∏è P/E: {pe:.2f}\n(‡∏Å‡∏•‡∏≤‡∏á‡πÜ)")
                        s1 = 0.5
                    else:
                        st.error(f"‚ùå P/E: {pe:.2f}\n(‡πÅ‡∏û‡∏á)")
                        s1 = 0
                
                # 2. ‡∏õ‡∏±‡∏ô‡∏ú‡∏• (Dividend)
                with c2:
                    st.subheader("2. ‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏ô‡∏ú‡∏•")
                    if div_yield > 4:
                        st.success(f"‚úÖ ‡∏õ‡∏±‡∏ô‡∏ú‡∏•: {div_yield:.2f}%\n(‡∏á‡∏≤‡∏°)")
                        s2 = 1
                    elif 2 <= div_yield <= 4:
                        st.warning(f"‚ö†Ô∏è ‡∏õ‡∏±‡∏ô‡∏ú‡∏•: {div_yield:.2f}%\n(‡∏û‡∏≠‡πÉ‡∏ä‡πâ)")
                        s2 = 0.5
                    else:
                        st.error(f"‚ùå ‡∏õ‡∏±‡∏ô‡∏ú‡∏•: {div_yield:.2f}%\n(‡∏ô‡πâ‡∏≠‡∏¢)")
                        s2 = 0
                        
                # 3. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏á (ROE)
                with c3:
                    st.subheader("3. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏á")
                    if roe > 15:
                        st.success(f"‚úÖ ROE: {roe:.2f}%\n(‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å)")
                        s3 = 1
                    elif 8 <= roe <= 15:
                        st.warning(f"‚ö†Ô∏è ROE: {roe:.2f}%\n(‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)")
                        s3 = 0.5
                    else:
                        st.error(f"‚ùå ROE: {roe:.2f}%\n(‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à)")
                        s3 = 0

                st.divider()
                
                # --- ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Å‡∏£‡∏î ---
                total_score = s1 + s2 + s3
                st.subheader("üéì ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:")
                
                if total_score >= 2.5:
                    st.balloons()
                    st.success(f"üíé GRADE A ({total_score}/3): ‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏û‡∏ä‡∏£‡πÉ‡∏ô‡∏ï‡∏°! ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏ô‡πà‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ ‡∏õ‡∏±‡∏ô‡∏ú‡∏•‡∏á‡∏≤‡∏° ‡∏ô‡πà‡∏≤‡∏Ñ‡∏ö‡∏´‡∏≤")
                elif total_score >= 1.5:
                    st.info(f"ü•á GRADE B ({total_score}/3): ‡∏´‡∏∏‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏î‡∏µ ‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏û‡∏á‡πÑ‡∏õ‡∏ô‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ô‡∏ú‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢)")
                else:
                    st.error(f"üíÄ GRADE C ({total_score}/3): ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á! ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πá‡πÅ‡∏û‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ")
                    
            except Exception as e:
                st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô {symbol} ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏á‡∏ö‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö")
