import streamlit as st
import yfinance as yf
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import datetime

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Strategic Planner & Oracle", page_icon="üîÆ", layout="wide")

st.title("üîÆ Strategic Planner: ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ & ‡∏à‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏ß‡∏ô")
st.markdown("**‡∏ú‡∏™‡∏≤‡∏ô‡∏û‡∏•‡∏±‡∏á '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô' (DCA) + '‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏™‡∏ß‡∏ô‡∏ï‡∏•‡∏≤‡∏î' (Mean Reversion)**")

# --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå ---
ASSETS = {
    # ‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏ó‡∏¢ (10 ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å)
    "üáπüá≠ PTT (‡∏õ‡∏ï‡∏ó.)": "PTT.BK",
    "üáπüá≠ CPALL (‡πÄ‡∏ã‡πÄ‡∏ß‡πà‡∏ô)": "CPALL.BK",
    "üáπüá≠ GULF (‡∏Å‡∏±‡∏•‡∏ü‡πå)": "GULF.BK",
    "üáπüá≠ ADVANC (AIS)": "ADVANC.BK",
    "üáπüá≠ PTTEP (‡∏™‡∏ú.)": "PTTEP.BK",
    "üáπüá≠ SCB (‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå)": "SCB.BK",
    "üáπüá≠ KBANK (‡∏Å‡∏™‡∏¥‡∏Å‡∏£)": "KBANK.BK",
    "üáπüá≠ AOT (‡∏ó‡πà‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô)": "AOT.BK",
    "üáπüá≠ BDMS (‡∏£‡∏û.‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û)": "BDMS.BK",
    "üáπüá≠ LH (‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏Ø)": "LH.BK",
    
    # ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡πÇ‡∏•‡∏Å & ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    "üåé SCBSEMI (‡πÉ‡∏ä‡πâ SMH)": "SMH",
    "üåé SCBRMNDQ (‡πÉ‡∏ä‡πâ QQQ)": "QQQ",
    "üåé SCBRMS&P500 (‡πÉ‡∏ä‡πâ SPY)": "SPY",
    "üåé SCBGQUAL (‡πÉ‡∏ä‡πâ QUAL)": "QUAL",
    "ü•á Gold (‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥)": "GLD",
    "üçé Apple (AAPL)": "AAPL",
    "üöÄ Nvidia (NVDA)": "NVDA"
}

# --- Sidebar ---
st.sidebar.header("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢")
selected_asset_name = st.sidebar.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå", list(ASSETS.keys()))
ticker = ASSETS[selected_asset_name]

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Bollinger Bands (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Oracle) ---
def calculate_bollinger_bands(df, window=20, num_std=2):
    # ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏•‡∏≤‡∏á (SMA 20)
    df['SMA'] = df['Close'].rolling(window=window).mean()
    # ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Volatility)
    df['STD'] = df['Close'].rolling(window=window).std()
    # ‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô (Upper Band)
    df['Upper'] = df['SMA'] + (df['STD'] * num_std)
    # ‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á (Lower Band)
    df['Lower'] = df['SMA'] - (df['STD'] * num_std)
    # %B (‡∏ö‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≠ 0=‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î, 1=‡∏ö‡∏ô‡∏™‡∏∏‡∏î)
    df['PctB'] = (df['Close'] - df['Lower']) / (df['Upper'] - df['Lower'])
    return df

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Shared) ---
@st.cache_data(ttl=3600)
def get_data(ticker, period="2y"):
    try:
        df = yf.download(ticker, period=period, interval="1d", progress=False)
        if isinstance(df.columns, pd.MultiIndex): df.columns = df.columns.get_level_values(0)
        return df
    except: return None

# --- Main Layout ---
tab1, tab2 = st.tabs(["üìÖ 1. ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô DCA (‡∏´‡∏≤‡∏§‡∏Å‡∏©‡πå‡∏ã‡∏∑‡πâ‡∏≠)", "üîÆ 2. The Oracle (‡∏à‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏ß‡∏ô)"])

# ==============================================================================
# TAB 1: DCA PLANNER (‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
# ==============================================================================
with tab1:
    st.subheader("üìÖ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á: ‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?")
    years_back = st.slider("‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏µ‡πà‡∏õ‡∏µ?", 1, 5, 3, key="dca_slider")
    
    df_hist = get_data(ticker, period=f"{years_back}y")
    
    if df_hist is not None:
        df = df_hist.copy()
        df['Day'] = df.index.day
        df['Month'] = df.index.month
        df['Year'] = df.index.year
        
        monthly_avg = df.groupby(['Year', 'Month'])['Close'].transform('mean')
        df['Diff_Pct'] = ((df['Close'] - monthly_avg) / monthly_avg) * 100
        
        dca_stats = df.groupby('Day')['Diff_Pct'].mean().reset_index()
        
        # Plot
        today_day = datetime.date.today().day
        dca_stats['Color'] = dca_stats['Diff_Pct'].apply(lambda x: '#22c55e' if x < 0 else '#ef4444')
        dca_stats['Color'] = dca_stats.apply(lambda x: '#3b82f6' if x['Day'] == today_day else x['Color'], axis=1)

        fig = go.Figure()
        fig.add_trace(go.Bar(
            x=dca_stats['Day'],
            y=dca_stats['Diff_Pct'],
            marker_color=dca_stats['Color'],
            text=dca_stats['Diff_Pct'].apply(lambda x: f"{x:.2f}%"),
            textposition='auto'
        ))
        fig.update_layout(title="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡πÅ‡∏û‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)", height=400)
        st.plotly_chart(fig, use_container_width=True)
        
        # Suggestion
        best_days = dca_stats.sort_values('Diff_Pct').head(5)
        st.success(f"‚úÖ **‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢):** {', '.join([str(d) for d in best_days['Day'].tolist()])}")

        # ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≤‡∏¢‡∏´‡∏°‡∏π (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡πà‡∏≤‡∏¢)
        st.write("---")
        st.subheader("üßÆ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≤‡∏¢‡∏´‡∏°‡∏π (Take Profit)")
        c1, c2, c3 = st.columns(3)
        last_price = df_hist['Close'].iloc[-1]
        with c1:
            buy_price = st.number_input("‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤", value=float(last_price), format="%.2f")
        with c2:
            target_pct = st.number_input("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡πÑ‡∏£‡∏Å‡∏µ‡πà %", value=5.0, step=0.5)
        with c3:
            sell_price = buy_price * (1 + target_pct/100)
            profit_amt = sell_price - buy_price
            st.metric("üéØ ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤", f"{sell_price:,.2f}", f"‡∏Å‡∏≥‡πÑ‡∏£ {profit_amt:,.2f} ‡∏ö.")

# ==============================================================================
# TAB 2: THE ORACLE (Bollinger Bands)
# ==============================================================================
with tab2:
    st.subheader(f"üîÆ The Oracle: ‡∏à‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏ß‡∏ô‡∏ï‡∏•‡∏≤‡∏î ({selected_asset_name})")
    st.markdown("""
    **‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:** ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ **‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á (Oversold)** ‡πÅ‡∏•‡∏∞ ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ **‡∏ó‡∏∞‡∏•‡∏∏‡∏Å‡∏£‡∏≠‡∏ö‡∏ö‡∏ô (Overbought)**
    """)
    
    df_oracle = get_data(ticker, period="1y")
    
    if df_oracle is not None:
        df_oracle = calculate_bollinger_bands(df_oracle)
        
        last_close = df_oracle['Close'].iloc[-1]
        last_upper = df_oracle['Upper'].iloc[-1]
        last_lower = df_oracle['Lower'].iloc[-1]
        last_pct_b = df_oracle['PctB'].iloc[-1]
        
        # --- ‡πÄ‡∏Å‡∏à‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡πÅ‡∏û‡∏á ---
        col_gauge, col_advice = st.columns([1, 2])
        
        with col_gauge:
            fig_gauge = go.Figure(go.Indicator(
                mode = "gauge+number",
                value = last_pct_b * 100,
                title = {'text': "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å/‡πÅ‡∏û‡∏á (Relative Price)"},
                gauge = {
                    'axis': {'range': [-20, 120]},
                    'bar': {'color': "black"},
                    'steps': [
                        {'range': [-20, 0], 'color': "darkgreen"},
                        {'range': [0, 20], 'color': "green"},
                        {'range': [20, 80], 'color': "lightgray"},
                        {'range': [80, 100], 'color': "red"},
                        {'range': [100, 120], 'color': "darkred"}
                    ],
                    'threshold': {'line': {'color': "blue", 'width': 4}, 'thickness': 0.75, 'value': last_pct_b * 100}
                }
            ))
            st.plotly_chart(fig_gauge, use_container_width=True)
            
        with col_advice:
            st.markdown("### ü§ñ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å Oracle")
            
            if last_close < last_lower:
                status = "üíé OVERSOLD (‡∏ñ‡∏π‡∏Å‡∏°‡∏≤‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥)"
                action_text = "üü¢ **‡∏ä‡πâ‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Strong Buy)!** ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡∏á"
                bg_color = "#d1fae5"
            elif last_close > last_upper:
                status = "üî• OVERBOUGHT (‡πÅ‡∏û‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)"
                action_text = "üî¥ **‡πÄ‡∏ó‡∏Ç‡∏≤‡∏¢‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£ (Sell)!** ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏≤‡∏°‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏≤‡∏à‡∏¢‡πà‡∏≠‡∏ï‡∏±‡∏ß"
                bg_color = "#fee2e2"
            elif last_pct_b < 0.2:
                status = "üõí CHEAP (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å)"
                action_text = "üü¢ **‡∏ó‡∏¢‡∏≠‡∏¢‡∏™‡∏∞‡∏™‡∏° (Buy)** ‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô"
                bg_color = "#ecfccb"
            elif last_pct_b > 0.8:
                status = "‚ö†Ô∏è EXPENSIVE (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏û‡∏á)"
                action_text = "üü† **‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á (Hold/Wait)** ‡∏≠‡∏¢‡πà‡∏≤‡πÑ‡∏•‡πà‡∏£‡∏≤‡∏Ñ‡∏≤"
                bg_color = "#ffedd5"
            else:
                status = "‚öñÔ∏è FAIR (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡πÜ)"
                action_text = "‚ö™ **‡∏ñ‡∏∑‡∏≠/‡∏£‡∏≠ (Wait)** ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏¥‡πà‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥"
                bg_color = "#f3f4f6"

            st.markdown(f"""
            <div style="background-color: {bg_color}; padding: 20px; border-radius: 10px; border: 1px solid #ccc;">
                <h2 style="margin:0;">{status}</h2>
                <p style="font-size: 1.2em; margin-top: 10px;">{action_text}</p>
                <hr>
                <p><strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> {last_close:,.2f}</p>
                <p><strong>‡∏Å‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á (‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö):</strong> {last_lower:,.2f}</p>
                <p><strong>‡∏Å‡∏£‡∏≠‡∏ö‡∏ö‡∏ô (‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô):</strong> {last_upper:,.2f}</p>
            </div>
            """, unsafe_allow_html=True)

        # --- ‡∏Å‡∏£‡∏≤‡∏ü Bollinger Bands ---
        st.subheader("üìâ ‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß")
        
        fig_bb = go.Figure()
        fig_bb.add_trace(go.Scatter(
            x=df_oracle.index.tolist() + df_oracle.index.tolist()[::-1],
            y=df_oracle['Upper'].tolist() + df_oracle['Lower'].tolist()[::-1],
            fill='toself', fillcolor='rgba(0,100,80,0.1)', line=dict(color='rgba(255,255,255,0)'), name='Bollinger Band'
        ))
        fig_bb.add_trace(go.Scatter(x=df_oracle.index, y=df_oracle['Close'], name='‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô', line=dict(color='black')))
        fig_bb.add_trace(go.Scatter(x=df_oracle.index, y=df_oracle['Upper'], name='‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô (‡∏Ç‡∏≤‡∏¢)', line=dict(color='red', width=1, dash='dot')))
        fig_bb.add_trace(go.Scatter(x=df_oracle.index, y=df_oracle['Lower'], name='‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á (‡∏ã‡∏∑‡πâ‡∏≠)', line=dict(color='green', width=1, dash='dot')))
        fig_bb.add_trace(go.Scatter(x=df_oracle.index, y=df_oracle['SMA'], name='‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏Å‡∏•‡∏≤‡∏á)', line=dict(color='blue', width=1)))

        fig_bb.update_layout(height=500, xaxis_title="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", yaxis_title="‡∏£‡∏≤‡∏Ñ‡∏≤", hovermode="x unified")
        st.plotly_chart(fig_bb, use_container_width=True)
